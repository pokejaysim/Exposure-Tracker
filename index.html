<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- PWA Configuration -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#5a67d8">
    
    <!-- iOS PWA Support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="ExposureTracker">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%235a67d8'/><text x='50' y='50' font-size='50' text-anchor='middle' dy='.35em' fill='white'>🌟</text></svg>">
    
    <!-- Additional PWA Meta Tags -->
    <meta name="msapplication-TileColor" content="#5a67d8">
    <meta name="msapplication-TileImage" content="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%235a67d8'/><text x='50' y='50' font-size='50' text-anchor='middle' dy='.35em' fill='white'>🌟</text></svg>">
    <title>Exposure Therapy Progress Tracker</title>
     <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>
    
    <!-- User Info (hidden initially) -->
    <div class="user-info" id="userInfo" style="display: none;">
        <img id="userPhoto" src="" alt="User profile photo">
        <span id="userName"></span>
        <div class="connection-status" id="connectionStatus">
            <span class="status-indicator" id="statusIndicator">🟢</span>
            <span class="status-text" id="statusText">Online</span>
        </div>
        <button onclick="signOut()">Sign Out</button>
    </div>
    
    <!-- Offline Notice -->
    <div class="offline-notice" id="offlineNotice" style="display: none;">
        <div class="offline-content">
            <span>📴</span>
            <span>You're offline - data will sync when connection returns</span>
            <button onclick="hideOfflineNotice()" class="close-offline">×</button>
        </div>
    </div>
    
    <div class="container">
        <h1>🌟 Exposure Therapy Progress Tracker</h1>
        
        <!-- Login Screen -->
        <div id="loginScreen" class="login-container">
            <h2>Welcome to Your Exposure Therapy Tracker</h2>
            <p>Sign in with your Google account to securely save and access your progress from any device.</p>
            <button id="googleSignInButton" onclick="signIn()">
                <svg class="google-logo" viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Sign in with Google
            </button>
        </div>
        
        <!-- Main App (hidden initially) -->
        <div id="mainApp" style="display: none;">
            <!-- Export Button -->
            <button class="export-button" onclick="showExportOptions()">
                📥 Export Data
            </button>
            
            <div class="tabs">
                <button class="tab active" onclick="showSection('goals')">Life Goals</button>
                <button class="tab" onclick="showSection('exposures')">Exposure Log</button>
                <button class="tab" onclick="showSection('interoceptive')">Interoceptive Exposure</button>
                <button class="tab" id="summaryTab" onclick="showSection('summary')">
                    Weekly Summary
                    <span class="notification-dot" id="weeklyNotification" style="display: none;"></span>
                </button>
            </div>
            
            <!-- Life Goals Section -->
            <div id="goals" class="section active">
                <h2 style="color: #5a67d8; margin-bottom: 20px;">Top 10 Life Goals Without Anxiety</h2>
                <p style="color: #718096; margin-bottom: 30px;">What would you do if anxiety and panic didn't hold you back? Dream big!</p>
                
                <div id="motivationalQuote" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 15px; margin-bottom: 30px; text-align: center; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);">
                    <p style="font-size: 20px; font-style: italic; margin-bottom: 10px;" id="quoteText">"Courage is not the absence of fear, but rather the assessment that something else is more important than fear."</p>
                    <p style="font-size: 16px; opacity: 0.9;" id="quoteAuthor">- Franklin D. Roosevelt</p>
                </div>
                
                <div class="goals-grid" id="goalsGrid">
                    <!-- Goals will be dynamically generated -->
                </div>
            </div>
            
            <!-- Exposure Log Section -->
            <div id="exposures" class="section">
                <h2 style="color: #5a67d8; margin-bottom: 20px;">Log Your Exposure</h2>
                
                <div class="exposure-form">
                    <div class="reference-preview" id="referencePreview">
                        Reference Number: <span id="refNumberDisplay">-</span>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Date</label>
                            <input type="date" id="exposureDate" required onchange="updateReferencePreview()">
                        </div>
                        
                        <div class="form-group">
                            <label>Time</label>
                            <input type="time" id="exposureTime" required>
                        </div>
                        
                        <div class="form-group">
                            <label>Exposure Situation / Trigger</label>
                            <input type="text" id="exposureSituation" placeholder="e.g., Grocery store, elevator" required>
                        </div>
                        
                        <div class="form-group">
                            <label>Anticipated Anxiety (0-10)</label>
                            <input type="range" id="anticipatedAnxiety" class="anxiety-slider" min="0" max="10" value="5" step="0.5">
                            <span class="slider-value" id="anticipatedValue">5</span>
                        </div>
                        
                        <div class="form-group">
                            <label>Peak Anxiety During (0-10)</label>
                            <input type="range" id="peakAnxiety" class="anxiety-slider" min="0" max="10" value="5" step="0.5">
                            <span class="slider-value" id="peakValue">5</span>
                        </div>
                        
                        <div class="form-group">
                            <label>Duration of Exposure</label>
                            <input type="text" id="duration" placeholder="e.g., 15 minutes" required>
                        </div>
                        
                        <div class="form-group">
                            <label>What I Fear Will Happen</label>
                            <textarea id="fearWillHappen" placeholder="What are you afraid might happen?"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>What Actually Happened</label>
                            <textarea id="whatActuallyHappened" placeholder="What was the reality?"></textarea>
                        </div>
                        
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label>Notes or Reflections</label>
                            <textarea id="notes" placeholder="Any additional thoughts or observations"></textarea>
                        </div>
                        
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <input type="checkbox" id="graphAdded" style="width: 20px; height: 20px; cursor: pointer;">
                                <span>Graph added to physical workbook</span>
                            </label>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button class="btn" id="submitBtn" onclick="addExposure()">Add Exposure Entry</button>
                        <button class="btn btn-secondary" id="cancelEditBtn" style="display: none;" onclick="cancelEdit()">Cancel Edit</button>
                    </div>
                </div>
                
                <div class="exposures-list" id="exposuresList">
                    <h3 style="color: #4a5568; margin-bottom: 20px;">Your Exposure History</h3>
                    
                    <!-- Search and Filter Container -->
                    <div class="search-filter-container" id="searchFilterContainer">
                        <input type="text" 
                               class="search-input" 
                               id="searchInput" 
                               placeholder="Search exposures..."
                               onkeyup="filterExposures()">
                        
                        <select class="filter-select" id="anxietyFilter" onchange="filterExposures()">
                            <option value="">All Anxiety Levels</option>
                            <option value="low">Low (0-3)</option>
                            <option value="medium">Medium (4-6)</option>
                            <option value="high">High (7-10)</option>
                        </select>
                        
                        <select class="filter-select" id="dateFilter" onchange="filterExposures()">
                            <option value="">All Dates</option>
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                            <option value="3months">Last 3 Months</option>
                        </select>
                        
                        <button class="clear-filters" onclick="clearFilters()">Clear Filters</button>
                        
                        <div class="results-count" id="resultsCount"></div>
                    </div>
                    
                    <div id="exposuresContainer">
                        <!-- Exposures will be displayed here -->
                    </div>
                </div>
            </div>
            
            <!-- Interoceptive Exposure Section -->
            <div id="interoceptive" class="section">
                <h2 style="color: #5a67d8; margin-bottom: 20px;">Interoceptive Exposure</h2>
                <h3 style="color: #718096; margin-bottom: 15px;">Internal Sensations Exercises</h3>
                <p style="color: #718096; margin-bottom: 30px;">These exercises are designed to mimic the physical sensations experienced during panic. Use a timer for each.</p>
                
                <!-- Timer Widget -->
                <div id="timerWidget" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 20px; padding: 30px; margin-bottom: 30px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); text-align: center;">
                    <h3 style="color: white; margin-bottom: 20px; font-size: 24px;">Exercise Timer</h3>
                    
                    <!-- Timer Display -->
                    <div id="timerDisplay" style="font-size: 72px; color: white; font-weight: bold; margin: 20px 0; font-family: monospace; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);">
                        00:00
                    </div>
                    
                    <!-- Progress Bar -->
                    <div style="width: 100%; height: 10px; background: rgba(255, 255, 255, 0.3); border-radius: 5px; margin: 20px 0; overflow: hidden;">
                        <div id="timerProgress" style="width: 0%; height: 100%; background: white; transition: width 0.1s linear;"></div>
                    </div>
                    
                    <!-- Preset Buttons -->
                    <div style="display: flex; gap: 10px; justify-content: center; margin: 20px 0; flex-wrap: wrap;">
                        <button onclick="setTimerDuration(30)" style="padding: 10px 20px; background: rgba(255, 255, 255, 0.2); color: white; border: 2px solid white; border-radius: 25px; cursor: pointer; font-weight: bold; transition: all 0.3s;">30 sec</button>
                        <button onclick="setTimerDuration(60)" style="padding: 10px 20px; background: rgba(255, 255, 255, 0.2); color: white; border: 2px solid white; border-radius: 25px; cursor: pointer; font-weight: bold; transition: all 0.3s;">1 min</button>
                        <button onclick="setTimerDuration(90)" style="padding: 10px 20px; background: rgba(255, 255, 255, 0.2); color: white; border: 2px solid white; border-radius: 25px; cursor: pointer; font-weight: bold; transition: all 0.3s;">1.5 min</button>
                        <input type="number" id="customTimerInput" min="1" max="300" placeholder="Custom (sec)" style="width: 120px; padding: 10px; background: rgba(255, 255, 255, 0.2); color: white; border: 2px solid white; border-radius: 25px; text-align: center;" onchange="setTimerDuration(this.value)">
                    </div>
                    
                    <!-- Control Buttons -->
                    <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                        <button id="startTimerBtn" onclick="startTimer()" style="padding: 15px 30px; background: #48bb78; color: white; border: none; border-radius: 30px; cursor: pointer; font-size: 18px; font-weight: bold; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); transition: all 0.3s;">Start</button>
                        <button id="pauseTimerBtn" onclick="pauseTimer()" style="padding: 15px 30px; background: #f6ad55; color: white; border: none; border-radius: 30px; cursor: pointer; font-size: 18px; font-weight: bold; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); transition: all 0.3s; display: none;">Pause</button>
                        <button onclick="resetTimer()" style="padding: 15px 30px; background: #718096; color: white; border: none; border-radius: 30px; cursor: pointer; font-size: 18px; font-weight: bold; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); transition: all 0.3s;">Reset</button>
                        <button onclick="stopTimer()" style="padding: 15px 30px; background: #e53e3e; color: white; border: none; border-radius: 30px; cursor: pointer; font-size: 18px; font-weight: bold; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); transition: all 0.3s;">Stop</button>
                    </div>
                    
                    <!-- Current Exercise Display -->
                    <div id="currentExercise" style="margin-top: 20px; color: white; font-size: 18px; opacity: 0.9;"></div>
                </div>
                
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);">
                        <thead>
                            <tr style="background: #5a67d8; color: white;">
                                <th style="padding: 15px; text-align: left; border-top-left-radius: 10px;">Exercise</th>
                                <th style="padding: 15px; text-align: left;">Duration</th>
                                <th style="padding: 15px; text-align: left;">Instructions/Notes</th>
                                <th style="padding: 15px; text-align: center; border-top-right-radius: 10px; width: 120px;">Timer</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr style="border-bottom: 1px solid #e2e8f0;">
                                <td style="padding: 15px; font-weight: 600;">Hyperventilation</td>
                                <td style="padding: 15px;">1 min</td>
                                <td style="padding: 15px;">Breathe deeply and quickly through your mouth, as loudly and forcefully as possible. Maintain the pace.</td>
                                <td style="padding: 15px; text-align: center;"><button onclick="startExerciseTimer(60, 'Hyperventilation')" style="background: #48bb78; color: white; border: none; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 14px; font-weight: bold;">⏱️ Start</button></td>
                            </tr>
                            <tr style="border-bottom: 1px solid #e2e8f0; background: #f7fafc;">
                                <td style="padding: 15px; font-weight: 600;">Shaking head</td>
                                <td style="padding: 15px;">30 sec</td>
                                <td style="padding: 15px;">Shake your head side to side with eyes open. Then look straight ahead. Be gentle with your neck.</td>
                                <td style="padding: 15px; text-align: center;"><button onclick="startExerciseTimer(30, 'Shaking head')" style="background: #48bb78; color: white; border: none; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 14px; font-weight: bold;">⏱️ Start</button></td>
                            </tr>
                            <tr style="border-bottom: 1px solid #e2e8f0;">
                                <td style="padding: 15px; font-weight: 600;">Head between legs</td>
                                <td style="padding: 15px;">30 sec</td>
                                <td style="padding: 15px;">Sit in a chair, place head between legs, then stand up quickly. Be cautious with back problems.</td>
                                <td style="padding: 15px; text-align: center;"><button onclick="startExerciseTimer(30, 'Head between legs')" style="background: #48bb78; color: white; border: none; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 14px; font-weight: bold;">⏱️ Start</button></td>
                            </tr>
                            <tr style="border-bottom: 1px solid #e2e8f0; background: #f7fafc;">
                                <td style="padding: 15px; font-weight: 600;">Running in place / up stairs</td>
                                <td style="padding: 15px;">1 min</td>
                                <td style="padding: 15px;">Run quickly without slowing down. Focus on maintaining a fast pace.</td>
                                <td style="padding: 15px; text-align: center;"><button onclick="startExerciseTimer(60, 'Running in place / up stairs')" style="background: #48bb78; color: white; border: none; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 14px; font-weight: bold;">⏱️ Start</button></td>
                            </tr>
                            <tr style="border-bottom: 1px solid #e2e8f0;">
                                <td style="padding: 15px; font-weight: 600;">Muscle tension / Push-up hold</td>
                                <td style="padding: 15px;">1 min</td>
                                <td style="padding: 15px;">Sit and tense all muscles or hold a push-up position. Can use techniques from progressive muscle relaxation.</td>
                                <td style="padding: 15px; text-align: center;"><button onclick="startExerciseTimer(60, 'Muscle tension / Push-up hold')" style="background: #48bb78; color: white; border: none; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 14px; font-weight: bold;">⏱️ Start</button></td>
                            </tr>
                            <tr style="border-bottom: 1px solid #e2e8f0; background: #f7fafc;">
                                <td style="padding: 15px; font-weight: 600;">Hold your breath</td>
                                <td style="padding: 15px;">30 sec</td>
                                <td style="padding: 15px;">Take a deep breath and hold it for as long as you can if 30 seconds is too long.</td>
                                <td style="padding: 15px; text-align: center;"><button onclick="startExerciseTimer(30, 'Hold your breath')" style="background: #48bb78; color: white; border: none; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 14px; font-weight: bold;">⏱️ Start</button></td>
                            </tr>
                            <tr style="border-bottom: 1px solid #e2e8f0;">
                                <td style="padding: 15px; font-weight: 600;">Spinning</td>
                                <td style="padding: 15px;">1 min</td>
                                <td style="padding: 15px;">Use a swivel chair or spin while standing. Be careful to avoid injury.</td>
                                <td style="padding: 15px; text-align: center;"><button onclick="startExerciseTimer(60, 'Spinning')" style="background: #48bb78; color: white; border: none; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 14px; font-weight: bold;">⏱️ Start</button></td>
                            </tr>
                            <tr style="border-bottom: 1px solid #e2e8f0; background: #f7fafc;">
                                <td style="padding: 15px; font-weight: 600;">Breathing through a straw</td>
                                <td style="padding: 15px;">1 min</td>
                                <td style="padding: 15px;">Use a narrow straw while pinching your nose. Breathe only through the straw.</td>
                                <td style="padding: 15px; text-align: center;"><button onclick="startExerciseTimer(60, 'Breathing through a straw')" style="background: #48bb78; color: white; border: none; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 14px; font-weight: bold;">⏱️ Start</button></td>
                            </tr>
                            <tr style="border-bottom: 1px solid #e2e8f0;">
                                <td style="padding: 15px; font-weight: 600;">Chest breathing</td>
                                <td style="padding: 15px;">1 min</td>
                                <td style="padding: 15px;">Take a deep breath to puff up your chest, then continue with short, shallow chest breaths.</td>
                                <td style="padding: 15px; text-align: center;"><button onclick="startExerciseTimer(60, 'Chest breathing')" style="background: #48bb78; color: white; border: none; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 14px; font-weight: bold;">⏱️ Start</button></td>
                            </tr>
                            <tr>
                                <td style="padding: 15px; font-weight: 600;">Staring at a spot</td>
                                <td style="padding: 15px;">1.5 min</td>
                                <td style="padding: 15px;">Stare at a single point (wall or mirror image) without shifting your gaze. Try not to blink too much.</td>
                                <td style="padding: 15px; text-align: center; border-bottom-right-radius: 10px;"><button onclick="startExerciseTimer(90, 'Staring at a spot')" style="background: #48bb78; color: white; border: none; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 14px; font-weight: bold;">⏱️ Start</button></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div style="margin-top: 30px; padding: 20px; background: #edf2f7; border-radius: 10px; text-align: center;">
                    <p style="color: #4a5568; font-style: italic; margin: 0;">
                        Extracted from "When Panic Attacks – Module 4: Coping with Physical Alarms"
                    </p>
                </div>
            </div>
            
            <!-- Weekly Summary Section -->
            <div id="summary" class="section">
                <h2 style="color: #5a67d8; margin-bottom: 20px;">Weekly Progress Summary</h2>
                
                <div class="week-reminder" id="weekReminder" style="display: none;">
                    <h3>🔔 Time for Your Weekly Summary!</h3>
                    <p>It's Sunday evening - the perfect time to reflect on your week's progress and celebrate your courage!</p>
                </div>
                
                <div class="summary-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Week Of</label>
                            <input type="date" id="weekOf" required onchange="updateExposureCount()">
                        </div>
                        
                        <div class="form-group">
                            <label>Number of Exposures (Auto-calculated)</label>
                            <input type="number" id="numExposures" min="0" placeholder="0" readonly style="background: #edf2f7;">
                        </div>
                        
                        <div class="form-group">
                            <label>Most Difficult Exposure</label>
                            <input type="text" id="difficultExposure" placeholder="What was your biggest challenge?" required>
                        </div>
                        
                        <div class="form-group">
                            <label>Confidence Rating (0-10)</label>
                            <input type="range" id="confidenceRating" class="anxiety-slider" min="0" max="10" value="5" step="0.5">
                            <span class="slider-value" id="confidenceValue">5</span>
                        </div>
                        
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label>What I Learned This Week</label>
                            <textarea id="weeklyLearnings" placeholder="Key insights and progress from this week"></textarea>
                        </div>
                    </div>
                    
                    <button class="btn" onclick="addWeeklySummary()">Add Weekly Summary</button>
                </div>
                
                <div class="summaries-list" id="summariesList">
                    <h3 style="color: #4a5568; margin-bottom: 20px;">Your Weekly Progress</h3>
                    <!-- Summaries will be displayed here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Mobile Navigation -->
    <nav class="mobile-nav" id="mobileNav">
        <div class="mobile-nav-items">
            <button class="mobile-nav-item active" onclick="showSection('goals', true)">
                <span class="mobile-nav-icon">🎯</span>
                <span>Goals</span>
            </button>
            <button class="mobile-nav-item" onclick="showSection('exposures', true)">
                <span class="mobile-nav-icon">📝</span>
                <span>Log</span>
            </button>
            <button class="mobile-nav-item" onclick="showSection('interoceptive', true)">
                <span class="mobile-nav-icon">💓</span>
                <span>Internal</span>
            </button>
            <button class="mobile-nav-item" onclick="showSection('summary', true)">
                <span class="mobile-nav-icon">📊</span>
                <span>Summary</span>
                <span class="notification-dot" id="mobileWeeklyNotification" style="display: none; position: absolute; top: 5px; right: 20px;"></span>
            </button>
        </div>
    </nav>
    
    <!-- Firebase Scripts -->
    <script type="module">
        // Import Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut as firebaseSignOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, get, onValue, push, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        
        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCZKvgiW_EsScY8rI7D99Gxd9kMi-Vz2jI",
            authDomain: "exposure-therapy-tracker.firebaseapp.com",
            databaseURL: "https://exposure-therapy-tracker-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "exposure-therapy-tracker",
            storageBucket: "exposure-therapy-tracker.firebasestorage.app",
            messagingSenderId: "385161416023",
            appId: "1:385161416023:web:76f676f6cf9b96cfe8c212",
            measurementId: "G-23LLMC8CE1"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);
        const provider = new GoogleAuthProvider();
        
        // Global variables
        window.currentUser = null;
        window.goals = Array(10).fill('');
        window.exposures = [];
        window.summaries = [];
        window.editingExposureId = null;
        
        // Auth state observer
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // User is signed in
                window.currentUser = user;
                showMainApp(user);
                loadUserData(user.uid);
            } else {
                // User is signed out
                window.currentUser = null;
                showLoginScreen();
            }
            // Hide loading overlay
            document.getElementById('loadingOverlay').style.display = 'none';
        });
        
        // Sign in function
        window.signIn = async function() {
            try {
                const result = await signInWithPopup(auth, provider);
                // User will be handled by onAuthStateChanged
            } catch (error) {
                console.error('Sign in error:', error);
                alert('Failed to sign in. Please try again.');
            }
        }
        
        // Sign out function
        window.signOut = async function() {
            try {
                await firebaseSignOut(auth);
                // User will be handled by onAuthStateChanged
            } catch (error) {
                console.error('Sign out error:', error);
                alert('Failed to sign out. Please try again.');
            }
        }
        
        // Show main app
        function showMainApp(user) {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            document.getElementById('userInfo').style.display = 'flex';
            document.getElementById('userName').textContent = user.displayName || user.email;
            document.getElementById('userPhoto').src = user.photoURL || 'https://via.placeholder.com/32';
            
            // Initialize app components
            const today = new Date();
            const dateStr = today.getFullYear() + '-' + 
                          String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                          String(today.getDate()).padStart(2, '0');
            document.getElementById('exposureDate').value = dateStr;
            updateReferencePreview();
            setupSliders();
            updateMotivationalQuote();
            setInterval(checkWeeklyReminder, 60000);
        }
        
        // Show login screen
        function showLoginScreen() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('userInfo').style.display = 'none';
        }
        
        // Load user data
        function loadUserData(userId) {
            const userRef = ref(database, 'users/' + userId);
            const goalsRef = ref(database, 'users/' + userId + '/goals');
            const exposuresRef = ref(database, 'users/' + userId + '/exposures');
            const summariesRef = ref(database, 'users/' + userId + '/summaries');
            
            // Load goals
            onValue(goalsRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    window.goals = data;
                }
                renderGoals();
            });
            
            // Load exposures
            onValue(exposuresRef, (snapshot) => {
                const data = snapshot.val();
                window.exposures = data ? Object.entries(data).map(([id, exp]) => ({ ...exp, id })) : [];
                window.exposures.sort((a, b) => {
                    // Create full datetime for comparison (newest first)
                    const dateTimeA = new Date(`${a.date}T${a.time || '00:00'}:00`);
                    const dateTimeB = new Date(`${b.date}T${b.time || '00:00'}:00`);
                    return dateTimeB - dateTimeA;
                });
                renderExposures();
                checkWeeklyReminder();
            });
            
            // Load summaries
            onValue(summariesRef, (snapshot) => {
                const data = snapshot.val();
                window.summaries = data ? Object.entries(data).map(([id, sum]) => ({ ...sum, id })) : [];
                window.summaries.sort((a, b) => new Date(b.weekOf) - new Date(a.weekOf));
                renderSummaries();
            });
        }
        
        // Save functions
        window.saveGoals = async function() {
            if (!window.currentUser) return;
            
            try {
                await set(ref(database, 'users/' + window.currentUser.uid + '/goals'), window.goals);
            } catch (error) {
                console.error('Error saving goals:', error);
                alert('Failed to save goals. Please check your connection.');
            }
        }
        
        window.saveExposure = async function(exposure) {
            if (!window.currentUser) return;
            
            try {
                const exposuresRef = ref(database, 'users/' + window.currentUser.uid + '/exposures');
                if (exposure.id && typeof exposure.id === 'string') {
                    await set(ref(database, 'users/' + window.currentUser.uid + '/exposures/' + exposure.id), exposure);
                } else {
                    const newRef = push(exposuresRef);
                    exposure.id = newRef.key;
                    await set(newRef, exposure);
                }
            } catch (error) {
                console.error('Error saving exposure:', error);
                alert('Failed to save exposure. Please check your connection.');
            }
        }
        
        window.deleteExposureFromDb = async function(id) {
            if (!window.currentUser) return;
            
            try {
                await remove(ref(database, 'users/' + window.currentUser.uid + '/exposures/' + id));
            } catch (error) {
                console.error('Error deleting exposure:', error);
                alert('Failed to delete exposure. Please check your connection.');
            }
        }
        
        window.saveSummary = async function(summary) {
            if (!window.currentUser) return;
            
            try {
                const summariesRef = ref(database, 'users/' + window.currentUser.uid + '/summaries');
                const newRef = push(summariesRef);
                summary.id = newRef.key;
                await set(newRef, summary);
            } catch (error) {
                console.error('Error saving summary:', error);
                alert('Failed to save summary. Please check your connection.');
            }
        }
        
        window.deleteSummaryFromDb = async function(id) {
            if (!window.currentUser) return;
            
            try {
                await remove(ref(database, 'users/' + window.currentUser.uid + '/summaries/' + id));
            } catch (error) {
                console.error('Error deleting summary:', error);
                alert('Failed to delete summary. Please check your connection.');
            }
        }
        
        // Motivational quotes
        window.quotes = [
            { text: "Courage is not the absence of fear, but rather the assessment that something else is more important than fear.", author: "Franklin D. Roosevelt" },
            { text: "You gain strength, courage, and confidence by every experience in which you really stop to look fear in the face.", author: "Eleanor Roosevelt" },
            { text: "The cave you fear to enter holds the treasure you seek.", author: "Joseph Campbell" },
            { text: "Everything you want is on the other side of fear.", author: "Jack Canfield" },
            { text: "Fear is only as deep as the mind allows.", author: "Japanese Proverb" },
            { text: "You are braver than you believe, stronger than you seem, and smarter than you think.", author: "A.A. Milne" },
            { text: "The only way out is through.", author: "Robert Frost" },
            { text: "Feel the fear and do it anyway.", author: "Susan Jeffers" },
            { text: "Anxiety is the dizziness of freedom.", author: "Søren Kierkegaard" },
            { text: "You don't have to control your thoughts. You just have to stop letting them control you.", author: "Dan Millman" },
            { text: "Every small step forward is a victory worth celebrating.", author: "Anonymous" },
            { text: "Healing takes courage, and we all have courage, even if we have to dig a little to find it.", author: "Tori Amos" }
        ];
    </script>
    
    <script>
        // Non-module scripts
        
        // Convert 24h time to 12h AM/PM format
        function formatTime12Hour(time24) {
            if (!time24) return '';
            const [hours, minutes] = time24.split(':');
            const hour = parseInt(hours);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const hour12 = hour % 12 || 12;
            return `${hour12}:${minutes} ${ampm}`;
        }
        
        // Format date string (YYYY-MM-DD) to display format
        function formatDate(dateStr) {
            if (!dateStr) return '';
            const [year, month, day] = dateStr.split('-');
            const date = new Date(year, month - 1, day); // month is 0-indexed
            return date.toLocaleDateString();
        }
        
        // Check if weekly reminder should be shown
        function checkWeeklyReminder() {
            const now = new Date();
            const dayOfWeek = now.getDay();
            const hour = now.getHours();
            
            if (dayOfWeek === 0 && hour >= 21) {
                const thisWeekStart = new Date(now);
                thisWeekStart.setDate(now.getDate() - dayOfWeek);
                thisWeekStart.setHours(0, 0, 0, 0);
                
                const hasThisWeekSummary = window.summaries.some(summary => {
                    const summaryDate = new Date(summary.weekOf);
                    return summaryDate >= thisWeekStart;
                });
                
                if (!hasThisWeekSummary) {
                    document.getElementById('weeklyNotification').style.display = 'block';
                    const mobileNotification = document.getElementById('mobileWeeklyNotification');
                    if (mobileNotification) mobileNotification.style.display = 'block';
                } else {
                    document.getElementById('weeklyNotification').style.display = 'none';
                    const mobileNotification = document.getElementById('mobileWeeklyNotification');
                    if (mobileNotification) mobileNotification.style.display = 'none';
                }
            } else {
                document.getElementById('weeklyNotification').style.display = 'none';
                const mobileNotification = document.getElementById('mobileWeeklyNotification');
                if (mobileNotification) mobileNotification.style.display = 'none';
            }
        }
        
        // Get week bounds
        function getWeekBounds(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day;
            const sunday = new Date(d.setDate(diff));
            const saturday = new Date(d.setDate(diff + 6));
            
            sunday.setHours(0, 0, 0, 0);
            saturday.setHours(23, 59, 59, 999);
            
            return { start: sunday, end: saturday };
        }
        
        // Update exposure count
        function updateExposureCount() {
            const weekOfDate = document.getElementById('weekOf').value;
            if (!weekOfDate) return;
            
            const { start, end } = getWeekBounds(weekOfDate);
            
            const exposuresInWeek = window.exposures.filter(exposure => {
                const exposureDate = new Date(exposure.date);
                return exposureDate >= start && exposureDate <= end;
            });
            
            document.getElementById('numExposures').value = exposuresInWeek.length;
        }
        
        // Generate reference number
        function generateReferenceNumber(date = null) {
            const refDate = date ? new Date(date) : new Date(document.getElementById('exposureDate').value);
            const year = refDate.getFullYear().toString().slice(-2);
            const month = (refDate.getMonth() + 1).toString().padStart(2, '0');
            const day = refDate.getDate().toString().padStart(2, '0');
            
            const dateStr = `${refDate.getFullYear()}-${month}-${day}`;
            const existingCount = window.exposures.filter(exp => exp.date === dateStr).length;
            const exposureNum = (existingCount + 1).toString().padStart(3, '0');
            
            return `EXP-${year}${month}${day}-${exposureNum}`;
        }
        
        // Update reference preview
        function updateReferencePreview() {
            const dateInput = document.getElementById('exposureDate').value;
            if (dateInput) {
                const refNumber = generateReferenceNumber(dateInput);
                document.getElementById('refNumberDisplay').textContent = refNumber;
            } else {
                document.getElementById('refNumberDisplay').textContent = '-';
            }
        }
        
        // Update motivational quote
        function updateMotivationalQuote() {
            const randomQuote = window.quotes[Math.floor(Math.random() * window.quotes.length)];
            document.getElementById('quoteText').textContent = `"${randomQuote.text}"`;
            document.getElementById('quoteAuthor').textContent = `- ${randomQuote.author}`;
        }
        
        // Tab switching
        function showSection(sectionName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            if (event && event.target) event.target.classList.add('active');
            
            document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
            document.getElementById(sectionName).classList.add('active');
            
            if (sectionName === 'summary') {
                checkWeeklyReminder();
                const now = new Date();
                if (now.getDay() === 0 && now.getHours() >= 21) {
                    document.getElementById('weekReminder').style.display = 'block';
                }
            }
        }
        
        // Mobile navigation
        function showSectionMobile(sectionName) {
            // Update mobile nav buttons
            document.querySelectorAll('.mobile-nav-item').forEach(item => item.classList.remove('active'));
            event.target.closest('.mobile-nav-item').classList.add('active');
            
            // Update desktop tabs to match
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.textContent.toLowerCase().includes(sectionName.substring(0, 4))) {
                    tab.classList.add('active');
                }
            });
            
            // Show the section
            document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
            document.getElementById(sectionName).classList.add('active');
            
            // Scroll to top on mobile
            window.scrollTo(0, 0);
            
            if (sectionName === 'summary') {
                checkWeeklyReminder();
                const now = new Date();
                if (now.getDay() === 0 && now.getHours() >= 21) {
                    document.getElementById('weekReminder').style.display = 'block';
                }
            }
        }
        
        // Goals functionality
        function renderGoals() {
            const goalsGrid = document.getElementById('goalsGrid');
            goalsGrid.innerHTML = '';
            
            for (let i = 0; i < 10; i++) {
                const goalCard = document.createElement('div');
                goalCard.className = 'goal-card';
                goalCard.setAttribute('data-number', i + 1);
                goalCard.innerHTML = `
                    <h3 style="margin-bottom: 10px;">Goal #${i + 1}</h3>
                    <input type="text" 
                           class="goal-input" 
                           placeholder="Enter your goal..."
                           value="${window.goals[i] || ''}"
                           onchange="updateGoal(${i}, this.value)">
                `;
                goalsGrid.appendChild(goalCard);
            }
        }
        
        function updateGoal(index, value) {
            window.goals[index] = value;
            window.saveGoals();
        }
        
        // Exposure functionality
        function setupSliders() {
            const anticipatedSlider = document.getElementById('anticipatedAnxiety');
            const anticipatedValue = document.getElementById('anticipatedValue');
            anticipatedSlider.oninput = function() {
                anticipatedValue.textContent = this.value;
            };
            
            const peakSlider = document.getElementById('peakAnxiety');
            const peakValue = document.getElementById('peakValue');
            peakSlider.oninput = function() {
                peakValue.textContent = this.value;
            };
            
            const confidenceSlider = document.getElementById('confidenceRating');
            const confidenceValue = document.getElementById('confidenceValue');
            confidenceSlider.oninput = function() {
                confidenceValue.textContent = this.value;
            };
        }
        
        function addExposure() {
            // Get the date value directly from the input (YYYY-MM-DD format)
            const dateValue = document.getElementById('exposureDate').value;
            
            const exposure = {
                date: dateValue, // Store the date string directly without conversion
                time: document.getElementById('exposureTime').value,
                situation: document.getElementById('exposureSituation').value,
                anticipatedAnxiety: document.getElementById('anticipatedAnxiety').value,
                peakAnxiety: document.getElementById('peakAnxiety').value,
                duration: document.getElementById('duration').value,
                fearWillHappen: document.getElementById('fearWillHappen').value,
                whatActuallyHappened: document.getElementById('whatActuallyHappened').value,
                notes: document.getElementById('notes').value,
                graphAdded: document.getElementById('graphAdded').checked,
                id: window.editingExposureId || null,
                referenceNumber: window.editingExposureId ? 
                    window.exposures.find(e => e.id === window.editingExposureId).referenceNumber : 
                    document.getElementById('refNumberDisplay').textContent
            };
            
            if (!exposure.date || !exposure.situation || !exposure.duration || !exposure.time) {
                alert('Please fill in at least the date, time, situation, and duration fields.');
                return;
            }
            
            window.saveExposure(exposure);
            
            if (window.editingExposureId) {
                window.editingExposureId = null;
                document.getElementById('submitBtn').textContent = 'Add Exposure Entry';
                document.getElementById('cancelEditBtn').style.display = 'none';
            }
            
            clearForm();
            updateReferencePreview();
        }
        
        function clearForm() {
            const today = new Date();
            const dateStr = today.getFullYear() + '-' + 
                          String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                          String(today.getDate()).padStart(2, '0');
            document.getElementById('exposureDate').value = dateStr;
            document.getElementById('exposureSituation').value = '';
            document.getElementById('exposureTime').value = '';
            document.getElementById('anticipatedAnxiety').value = 5;
            document.getElementById('anticipatedValue').textContent = '5.0';
            document.getElementById('peakAnxiety').value = 5;
            document.getElementById('peakValue').textContent = '5.0';
            document.getElementById('duration').value = '';
            document.getElementById('fearWillHappen').value = '';
            document.getElementById('whatActuallyHappened').value = '';
            document.getElementById('notes').value = '';
            document.getElementById('graphAdded').checked = false;
        }
        
        function editExposure(id) {
            const exposure = window.exposures.find(e => e.id === id);
            if (!exposure) return;
            
            window.editingExposureId = id;
            
            document.getElementById('exposureDate').value = exposure.date;
            document.getElementById('exposureTime').value = exposure.time;
            document.getElementById('exposureSituation').value = exposure.situation;
            document.getElementById('anticipatedAnxiety').value = exposure.anticipatedAnxiety;
            document.getElementById('anticipatedValue').textContent = exposure.anticipatedAnxiety;
            document.getElementById('peakAnxiety').value = exposure.peakAnxiety;
            document.getElementById('peakValue').textContent = exposure.peakAnxiety;
            document.getElementById('duration').value = exposure.duration;
            document.getElementById('fearWillHappen').value = exposure.fearWillHappen || '';
            document.getElementById('whatActuallyHappened').value = exposure.whatActuallyHappened || '';
            document.getElementById('notes').value = exposure.notes || '';
            document.getElementById('graphAdded').checked = exposure.graphAdded || false;
            
            document.getElementById('refNumberDisplay').textContent = exposure.referenceNumber;
            
            document.getElementById('submitBtn').textContent = 'Update Exposure Entry';
            document.getElementById('cancelEditBtn').style.display = 'inline-block';
            
            document.querySelector('.exposure-form').scrollIntoView({ behavior: 'smooth' });
        }
        
        function cancelEdit() {
            window.editingExposureId = null;
            document.getElementById('submitBtn').textContent = 'Add Exposure Entry';
            document.getElementById('cancelEditBtn').style.display = 'none';
            clearForm();
            updateReferencePreview();
        }
        
        function renderExposures() {
            const searchContainer = document.getElementById('searchFilterContainer');
            
            if (window.exposures.length === 0) {
                searchContainer.style.display = 'none';
                document.getElementById('exposuresContainer').innerHTML = '<p style="color: #718096;">No exposures logged yet. Start tracking your progress!</p>';
                return;
            }
            
            searchContainer.style.display = 'flex';
            filteredExposures = window.exposures;
            renderFilteredExposures();
        }
        
        function deleteExposure(id) {
            if (confirm('Are you sure you want to delete this exposure?')) {
                window.deleteExposureFromDb(id);
            }
        }
        
        // Weekly Summary functionality
        function addWeeklySummary() {
            const summary = {
                weekOf: document.getElementById('weekOf').value,
                numExposures: document.getElementById('numExposures').value,
                difficultExposure: document.getElementById('difficultExposure').value,
                confidenceRating: document.getElementById('confidenceRating').value,
                learnings: document.getElementById('weeklyLearnings').value
            };
            
            if (!summary.weekOf || !summary.difficultExposure) {
                alert('Please fill in at least the week and most difficult exposure.');
                return;
            }
            
            window.saveSummary(summary);
            
            document.getElementById('weekOf').value = '';
            document.getElementById('numExposures').value = '';
            document.getElementById('difficultExposure').value = '';
            document.getElementById('confidenceRating').value = 5;
            document.getElementById('confidenceValue').textContent = '5.0';
            document.getElementById('weeklyLearnings').value = '';
            
            document.getElementById('weekReminder').style.display = 'none';
        }
        
        function renderSummaries() {
            const summariesList = document.getElementById('summariesList');
            
            if (window.summaries.length === 0) {
                summariesList.innerHTML = '<p style="color: #718096;">No weekly summaries yet. Complete your first week to add a summary!</p>';
                return;
            }
            
            summariesList.innerHTML = '<h3 style="color: #4a5568; margin-bottom: 20px;">Your Weekly Progress</h3>';
            
            window.summaries.forEach(summary => {
                const summaryItem = document.createElement('div');
                summaryItem.className = 'summary-item';
                summaryItem.innerHTML = `
                    <div class="summary-header">
                        Week of ${formatDate(summary.weekOf)}
                        <button onclick="deleteSummary('${summary.id}')" style="float: right; background: rgba(255,255,255,0.3); color: white; border: none; padding: 5px 15px; border-radius: 20px; cursor: pointer;">Delete</button>
                    </div>
                    <div>
                        <span class="summary-stat">${summary.numExposures} Exposures</span>
                        <span class="summary-stat">Confidence: ${summary.confidenceRating}/10</span>
                    </div>
                    <p style="margin-top: 15px;"><strong>Most Challenging:</strong> ${summary.difficultExposure}</p>
                    ${summary.learnings ? `<p style="margin-top: 10px;"><strong>Key Learnings:</strong> ${summary.learnings}</p>` : ''}
                `;
                summariesList.appendChild(summaryItem);
            });
        }
        
        function deleteSummary(id) {
            if (confirm('Are you sure you want to delete this weekly summary?')) {
                window.deleteSummaryFromDb(id);
            }
        }
        
        // Export functionality
        function showExportOptions() {
            // Create a mobile-friendly modal instead of using prompt
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
                padding: 20px;
            `;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white;
                border-radius: 20px;
                padding: 30px;
                max-width: 400px;
                width: 100%;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            `;
            
            modalContent.innerHTML = `
                <h3 style="color: #5a67d8; margin-bottom: 20px; text-align: center;">Export Your Data</h3>
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <button onclick="exportToCSV(); document.body.removeChild(document.body.lastElementChild);" 
                            style="padding: 15px; background: #48bb78; color: white; border: none; border-radius: 10px; font-size: 16px; cursor: pointer;">
                        📊 Export to CSV (Excel)
                    </button>
                    <button onclick="exportToJSON(); document.body.removeChild(document.body.lastElementChild);" 
                            style="padding: 15px; background: #5a67d8; color: white; border: none; border-radius: 10px; font-size: 16px; cursor: pointer;">
                        💾 Export to JSON (Backup)
                    </button>
                    <button onclick="exportToPDF(); document.body.removeChild(document.body.lastElementChild);" 
                            style="padding: 15px; background: #9f7aea; color: white; border: none; border-radius: 10px; font-size: 16px; cursor: pointer;">
                        📄 Export to PDF (Print)
                    </button>
                    <button onclick="document.body.removeChild(document.body.lastElementChild);" 
                            style="padding: 15px; background: #718096; color: white; border: none; border-radius: 10px; font-size: 16px; cursor: pointer;">
                        Cancel
                    </button>
                </div>
            `;
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // Close modal when clicking outside
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });
        }
        
        function exportToCSV() {
            let csv = 'Date,Time,Situation,Anticipated Anxiety,Peak Anxiety,Duration,Fear Expected,What Happened,Notes,Reference Number,Graph Added\n';
            
            window.exposures.forEach(exp => {
                const row = [
                    exp.date,
                    exp.time || '',
                    `"${exp.situation.replace(/"/g, '""')}"`,
                    exp.anticipatedAnxiety,
                    exp.peakAnxiety,
                    `"${exp.duration.replace(/"/g, '""')}"`,
                    `"${(exp.fearWillHappen || '').replace(/"/g, '""')}"`,
                    `"${(exp.whatActuallyHappened || '').replace(/"/g, '""')}"`,
                    `"${(exp.notes || '').replace(/"/g, '""')}"`,
                    exp.referenceNumber || '',
                    exp.graphAdded ? 'Yes' : 'No'
                ].join(',');
                csv += row + '\n';
            });
            
            // Add summary data
            csv += '\n\nWeekly Summaries\n';
            csv += 'Week Of,Number of Exposures,Most Difficult,Confidence Rating,Learnings\n';
            
            window.summaries.forEach(sum => {
                const row = [
                    sum.weekOf,
                    sum.numExposures,
                    `"${sum.difficultExposure.replace(/"/g, '""')}"`,
                    sum.confidenceRating,
                    `"${(sum.learnings || '').replace(/"/g, '""')}"`
                ].join(',');
                csv += row + '\n';
            });
            
            downloadFile(csv, 'exposure-therapy-data.csv', 'text/csv');
        }
        
        function exportToJSON() {
            const data = {
                exportDate: new Date().toISOString(),
                user: {
                    name: window.currentUser?.displayName || 'Unknown',
                    email: window.currentUser?.email || 'Unknown'
                },
                goals: window.goals,
                exposures: window.exposures,
                summaries: window.summaries
            };
            
            const json = JSON.stringify(data, null, 2);
            downloadFile(json, 'exposure-therapy-backup.json', 'application/json');
        }
        
        function exportToPDF() {
            // Create a printable HTML version
            let html = `
                <html>
                <head>
                    <title>Exposure Therapy Progress Report</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        h1, h2 { color: #5a67d8; }
                        .exposure { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
                        .goal { margin: 10px 0; padding: 10px; background: #f7fafc; }
                        @media print { .exposure { page-break-inside: avoid; } }
                    </style>
                </head>
                <body>
                    <h1>Exposure Therapy Progress Report</h1>
                    <p>Generated on: ${new Date().toLocaleDateString()}</p>
                    
                    <h2>Life Goals</h2>
            `;
            
            window.goals.forEach((goal, i) => {
                if (goal) {
                    html += `<div class="goal">${i + 1}. ${goal}</div>`;
                }
            });
            
            html += '<h2>Exposure History</h2>';
            
            window.exposures.forEach(exp => {
                html += `
                    <div class="exposure">
                        <strong>Date:</strong> ${formatDate(exp.date)} at ${formatTime12Hour(exp.time)}<br>
                        <strong>Situation:</strong> ${exp.situation}<br>
                        <strong>Peak Anxiety:</strong> ${exp.peakAnxiety}/10<br>
                        <strong>Duration:</strong> ${exp.duration}<br>
                        ${exp.fearWillHappen ? `<strong>Fear:</strong> ${exp.fearWillHappen}<br>` : ''}
                        ${exp.whatActuallyHappened ? `<strong>Reality:</strong> ${exp.whatActuallyHappened}<br>` : ''}
                        ${exp.notes ? `<strong>Notes:</strong> ${exp.notes}<br>` : ''}
                    </div>
                `;
            });
            
            html += '</body></html>';
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(html);
            printWindow.document.close();
            printWindow.print();
        }
        
        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // Search and filter functionality
        let filteredExposures = [];
        
        function filterExposures() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const anxietyLevel = document.getElementById('anxietyFilter').value;
            const dateRange = document.getElementById('dateFilter').value;
            
            filteredExposures = window.exposures.filter(exposure => {
                // Search filter
                const searchMatch = !searchTerm || 
                    exposure.situation.toLowerCase().includes(searchTerm) ||
                    (exposure.notes && exposure.notes.toLowerCase().includes(searchTerm)) ||
                    (exposure.fearWillHappen && exposure.fearWillHappen.toLowerCase().includes(searchTerm)) ||
                    (exposure.whatActuallyHappened && exposure.whatActuallyHappened.toLowerCase().includes(searchTerm));
                
                // Anxiety level filter
                let anxietyMatch = true;
                if (anxietyLevel) {
                    const peakAnxiety = parseFloat(exposure.peakAnxiety);
                    if (anxietyLevel === 'low') anxietyMatch = peakAnxiety <= 3;
                    else if (anxietyLevel === 'medium') anxietyMatch = peakAnxiety > 3 && peakAnxiety <= 6;
                    else if (anxietyLevel === 'high') anxietyMatch = peakAnxiety > 6;
                }
                
                // Date filter
                let dateMatch = true;
                if (dateRange) {
                    const exposureDate = new Date(exposure.date);
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    
                    if (dateRange === 'today') {
                        dateMatch = exposureDate.toDateString() === today.toDateString();
                    } else if (dateRange === 'week') {
                        const weekAgo = new Date(today);
                        weekAgo.setDate(today.getDate() - 7);
                        dateMatch = exposureDate >= weekAgo;
                    } else if (dateRange === 'month') {
                        const monthAgo = new Date(today);
                        monthAgo.setMonth(today.getMonth() - 1);
                        dateMatch = exposureDate >= monthAgo;
                    } else if (dateRange === '3months') {
                        const threeMonthsAgo = new Date(today);
                        threeMonthsAgo.setMonth(today.getMonth() - 3);
                        dateMatch = exposureDate >= threeMonthsAgo;
                    }
                }
                
                return searchMatch && anxietyMatch && dateMatch;
            });
            
            renderFilteredExposures();
        }
        
        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('anxietyFilter').value = '';
            document.getElementById('dateFilter').value = '';
            filteredExposures = window.exposures;
            renderFilteredExposures();
        }
        
        function renderFilteredExposures() {
            const container = document.getElementById('exposuresContainer');
            const resultsCount = document.getElementById('resultsCount');
            
            if (filteredExposures.length === 0) {
                container.innerHTML = '<p style="color: #718096;">No exposures match your filters.</p>';
                resultsCount.textContent = 'No results found';
                return;
            }
            
            resultsCount.textContent = `Showing ${filteredExposures.length} of ${window.exposures.length} exposures`;
            
            container.innerHTML = '';
            filteredExposures.forEach(exposure => {
                const anxietyClass = exposure.peakAnxiety <= 3 ? 'anxiety-low' : 
                                   exposure.peakAnxiety <= 6 ? 'anxiety-medium' : 'anxiety-high';
                
                const exposureItem = document.createElement('div');
                exposureItem.className = 'exposure-item';
                exposureItem.innerHTML = `
                    <div class="exposure-header">
                        <span class="exposure-date">${formatDate(exposure.date)} at ${formatTime12Hour(exposure.time)}</span>
                        <div>
                            <span class="anxiety-badge ${anxietyClass}">Peak: ${exposure.peakAnxiety}/10</span>
                            <button onclick="editExposure('${exposure.id}')" class="btn btn-edit" style="margin-left: 10px;">Edit</button>
                            <button onclick="deleteExposure('${exposure.id}')" style="margin-left: 10px; background: #e53e3e; color: white; border: none; padding: 5px 15px; border-radius: 20px; cursor: pointer;">Delete</button>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4 style="color: #2d3748; margin: 0;">${exposure.situation}</h4>
                        <span style="background: #edf2f7; color: #4a5568; padding: 5px 12px; border-radius: 20px; font-size: 14px; font-weight: 600;">
                            ${exposure.referenceNumber || 'No Ref #'}
                        </span>
                    </div>
                    ${exposure.graphAdded ? '<p style="color: #48bb78; font-weight: 600; margin-bottom: 10px;">✓ Graph added to physical workbook</p>' : ''}
                    <div style="display: grid; gap: 10px; color: #4a5568;">
                        <p><strong>Duration:</strong> ${exposure.duration}</p>
                        <p><strong>Anticipated vs Peak Anxiety:</strong> ${exposure.anticipatedAnxiety}/10 → ${exposure.peakAnxiety}/10</p>
                        ${exposure.fearWillHappen ? `<p><strong>What I Feared Would Happen:</strong> ${exposure.fearWillHappen}</p>` : ''}
                        ${exposure.whatActuallyHappened ? `<p><strong>What Actually Happened:</strong> ${exposure.whatActuallyHappened}</p>` : ''}
                        ${exposure.notes ? `<p><strong>Notes:</strong> ${exposure.notes}</p>` : ''}
                    </div>
                `;
                container.appendChild(exposureItem);
            });
        }
        
        // Timer functionality
        let timerInterval = null;
        let timerDuration = 0;
        let timerRemaining = 0;
        let timerPaused = false;
        let timerOriginalDuration = 0;
        
        function setTimerDuration(seconds) {
            timerDuration = parseInt(seconds);
            timerRemaining = timerDuration;
            timerOriginalDuration = timerDuration;
            updateTimerDisplay();
            updateProgressBar();
        }
        
        function updateTimerDisplay() {
            const minutes = Math.floor(timerRemaining / 60);
            const seconds = timerRemaining % 60;
            const display = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('timerDisplay').textContent = display;
        }
        
        function updateProgressBar() {
            const progress = timerOriginalDuration > 0 ? ((timerOriginalDuration - timerRemaining) / timerOriginalDuration) * 100 : 0;
            document.getElementById('timerProgress').style.width = progress + '%';
        }
        
        function startTimer() {
            if (timerDuration === 0) {
                alert('Please set a timer duration first.');
                return;
            }
            
            if (timerPaused) {
                timerPaused = false;
            } else {
                timerRemaining = timerDuration;
            }
            
            // Update UI
            document.getElementById('startTimerBtn').style.display = 'none';
            document.getElementById('pauseTimerBtn').style.display = 'inline-block';
            
            // Add pulsing effect to timer widget
            const timerWidget = document.getElementById('timerWidget');
            timerWidget.style.animation = 'pulse 2s infinite';
            timerWidget.style.border = '3px solid #48bb78';
            
            // Create CSS for pulse animation if it doesn't exist
            if (!document.getElementById('timerStyles')) {
                const style = document.createElement('style');
                style.id = 'timerStyles';
                style.textContent = `
                    @keyframes pulse {
                        0% { box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2), 0 0 0 0 rgba(72, 187, 120, 0.7); }
                        70% { box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2), 0 0 0 10px rgba(72, 187, 120, 0); }
                        100% { box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2), 0 0 0 0 rgba(72, 187, 120, 0); }
                    }
                `;
                document.head.appendChild(style);
            }
            
            timerInterval = setInterval(() => {
                timerRemaining--;
                updateTimerDisplay();
                updateProgressBar();
                
                if (timerRemaining <= 0) {
                    finishTimer();
                }
            }, 1000);
        }
        
        function pauseTimer() {
            timerPaused = true;
            clearInterval(timerInterval);
            
            // Update UI
            document.getElementById('startTimerBtn').style.display = 'inline-block';
            document.getElementById('startTimerBtn').textContent = 'Resume';
            document.getElementById('pauseTimerBtn').style.display = 'none';
            
            // Remove pulsing effect
            const timerWidget = document.getElementById('timerWidget');
            timerWidget.style.animation = '';
            timerWidget.style.border = '';
        }
        
        function resetTimer() {
            clearInterval(timerInterval);
            timerPaused = false;
            timerRemaining = timerDuration;
            
            // Update UI
            document.getElementById('startTimerBtn').style.display = 'inline-block';
            document.getElementById('startTimerBtn').textContent = 'Start';
            document.getElementById('pauseTimerBtn').style.display = 'none';
            document.getElementById('currentExercise').textContent = '';
            
            // Remove pulsing effect
            const timerWidget = document.getElementById('timerWidget');
            timerWidget.style.animation = '';
            timerWidget.style.border = '';
            
            updateTimerDisplay();
            updateProgressBar();
        }
        
        function stopTimer() {
            clearInterval(timerInterval);
            timerPaused = false;
            timerRemaining = 0;
            timerDuration = 0;
            timerOriginalDuration = 0;
            
            // Update UI
            document.getElementById('startTimerBtn').style.display = 'inline-block';
            document.getElementById('startTimerBtn').textContent = 'Start';
            document.getElementById('pauseTimerBtn').style.display = 'none';
            document.getElementById('currentExercise').textContent = '';
            
            // Remove pulsing effect
            const timerWidget = document.getElementById('timerWidget');
            timerWidget.style.animation = '';
            timerWidget.style.border = '';
            
            updateTimerDisplay();
            updateProgressBar();
        }
        
        function finishTimer() {
            clearInterval(timerInterval);
            
            // Update UI
            document.getElementById('startTimerBtn').style.display = 'inline-block';
            document.getElementById('startTimerBtn').textContent = 'Start';
            document.getElementById('pauseTimerBtn').style.display = 'none';
            
            // Remove pulsing effect
            const timerWidget = document.getElementById('timerWidget');
            timerWidget.style.animation = '';
            timerWidget.style.border = '';
            
            // Flash the timer display
            const timerDisplay = document.getElementById('timerDisplay');
            timerDisplay.style.color = '#48bb78';
            timerDisplay.textContent = 'DONE!';
            
            setTimeout(() => {
                timerDisplay.style.color = 'white';
                updateTimerDisplay();
            }, 3000);
            
            // Play completion sound
            playCompletionSound();
            
            // Show completion alert
            setTimeout(() => {
                const exerciseName = document.getElementById('currentExercise').textContent.replace('Current Exercise: ', '');
                alert(`🎉 Timer Complete! ${exerciseName ? 'Great job on the ' + exerciseName + ' exercise!' : 'Well done!'}`);
            }, 500);
        }
        
        function startExerciseTimer(seconds, exerciseName) {
            setTimerDuration(seconds);
            document.getElementById('currentExercise').textContent = 'Current Exercise: ' + exerciseName;
            
            // Scroll to timer for visibility
            document.getElementById('timerWidget').scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // Auto-start the timer after a brief delay
            setTimeout(() => {
                startTimer();
            }, 500);
        }
        
        function playCompletionSound() {
            // Create audio context for browser compatibility
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // Create a simple completion tone
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                oscillator.frequency.setValueAtTime(1000, audioContext.currentTime + 0.1);
                oscillator.frequency.setValueAtTime(1200, audioContext.currentTime + 0.2);
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch (error) {
                // Fallback: try to play a simple beep using different method
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmocBzKH0fPTgjMGHWi+8OOaVAkZaL3r6KNLDAlJo+HyvmUcBjKGz/LJeykGIYDA7eCUQAoRVKzn8K5YFAhFmt7xwF0fCDOGzfPOgjIGHWi+8OCUPwkRUKzl8KtWEghEm97yu2QcBzKGz/PKeSgGIYHA7t+UQAoUXrTo7alVFApGnt/xwV4fCDOGzfPOgzEGHWm+8OCUPwkQUKzl8KtWEghEm97yu2QcBzKGz/PKeSgGIYHA7t+UQAoUXrTo7alVFApGnt/xwV4fCDOGzfPOgzEGHWm+8OCUPwkQUKzl8KtWEghEm97yu2QcBzKGz/PKeSgGIYHA7t+UQAoUXrTo7alVFApGnt/xwV4fCDOGzfPOgzEGHWm+8OCUPwkQUKzl8KtWEghEm97yu2QcBzKGz/PKeSgGIYHA7t+UQAoUXrTo7alVFApGnt/xwV4fCDOGzfPOgzEGHWm+8OCUPwkQUKzl8KtWEgg=');
                audio.play().catch(() => {
                    // Silent fallback if audio fails
                });
            }
        }
        
        // PWA and Offline Functionality
        let isOnline = navigator.onLine;
        let syncInProgress = false;
        
        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('SW registered:', registration);
                        
                        // Handle service worker updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed') {
                                    if (navigator.serviceWorker.controller) {
                                        // New update available
                                        showUpdateNotification();
                                    }
                                }
                            });
                        });
                    })
                    .catch(error => {
                        console.error('SW registration failed:', error);
                    });
                
                // Listen for service worker messages
                navigator.serviceWorker.addEventListener('message', handleSWMessage);
            });
        }
        
        // Handle service worker messages
        function handleSWMessage(event) {
            if (event.data && event.data.type === 'BACKGROUND_SYNC') {
                console.log('Background sync triggered');
                syncOfflineData();
            }
        }
        
        // Online/Offline event listeners
        window.addEventListener('online', () => {
            isOnline = true;
            updateConnectionStatus();
            hideOfflineNotice();
            // Trigger sync when coming back online
            setTimeout(syncOfflineData, 1000);
        });
        
        window.addEventListener('offline', () => {
            isOnline = false;
            updateConnectionStatus();
            showOfflineNotice();
        });
        
        // Update connection status indicator
        function updateConnectionStatus() {
            const indicator = document.getElementById('statusIndicator');
            const text = document.getElementById('statusText');
            
            if (isOnline) {
                indicator.textContent = '🟢';
                text.textContent = syncInProgress ? 'Syncing...' : 'Online';
                text.style.color = '#48bb78';
            } else {
                indicator.textContent = '🔴';
                text.textContent = 'Offline';
                text.style.color = '#f56565';
            }
        }
        
        // Show offline notice
        function showOfflineNotice() {
            const notice = document.getElementById('offlineNotice');
            if (notice) {
                notice.style.display = 'block';
                setTimeout(() => {
                    notice.style.opacity = '1';
                    notice.style.transform = 'translateY(0)';
                }, 100);
            }
        }
        
        // Hide offline notice
        function hideOfflineNotice() {
            const notice = document.getElementById('offlineNotice');
            if (notice) {
                notice.style.opacity = '0';
                notice.style.transform = 'translateY(-100%)';
                setTimeout(() => {
                    notice.style.display = 'none';
                }, 300);
            }
        }
        
        // Show update notification
        function showUpdateNotification() {
            if (confirm('A new version is available. Reload to update?')) {
                window.location.reload();
            }
        }
        
        // Offline data management
        function getOfflineData() {
            return JSON.parse(localStorage.getItem('offlineExposureData')) || {
                exposures: [],
                goals: [...window.goals],
                summaries: [],
                syncQueue: [],
                lastSync: null
            };
        }
        
        function saveOfflineData(data) {
            localStorage.setItem('offlineExposureData', JSON.stringify(data));
        }
        
        // Enhanced save functions for offline support
        window.saveExposureOffline = function(exposure) {
            const offlineData = getOfflineData();
            
            // Add temporary ID and mark as pending sync
            if (!exposure.id) {
                exposure.id = 'temp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                exposure._pendingSync = true;
            }
            
            // Add to offline storage
            const existingIndex = offlineData.exposures.findIndex(e => e.id === exposure.id);
            if (existingIndex >= 0) {
                offlineData.exposures[existingIndex] = { ...exposure };
            } else {
                offlineData.exposures.push({ ...exposure });
            }
            
            // Add to sync queue
            offlineData.syncQueue.push({
                action: exposure._pendingSync ? 'create' : 'update',
                type: 'exposure',
                data: { ...exposure },
                timestamp: Date.now()
            });
            
            saveOfflineData(offlineData);
            
            // Try to sync immediately if online
            if (isOnline) {
                setTimeout(syncOfflineData, 500);
            }
            
            return exposure;
        };
        
        // Sync offline data when online
        async function syncOfflineData() {
            if (!isOnline || syncInProgress) return;
            
            const offlineData = getOfflineData();
            if (!offlineData.syncQueue || offlineData.syncQueue.length === 0) return;
            
            syncInProgress = true;
            updateConnectionStatus();
            
            console.log('Syncing', offlineData.syncQueue.length, 'offline operations...');
            
            const successfulSyncs = [];
            
            for (const operation of offlineData.syncQueue) {
                try {
                    switch (operation.action) {
                        case 'create':
                            if (operation.type === 'exposure') {
                                // Remove temporary fields before saving
                                const exposureData = { ...operation.data };
                                delete exposureData._pendingSync;
                                
                                // If it has a temp ID, let Firebase generate a real one
                                if (exposureData.id && exposureData.id.startsWith('temp_')) {
                                    delete exposureData.id;
                                }
                                
                                await window.saveExposure(exposureData);
                                console.log('Synced exposure:', exposureData.referenceNumber);
                            }
                            break;
                        case 'update':
                            if (operation.type === 'exposure') {
                                await window.saveExposure(operation.data);
                                console.log('Updated exposure:', operation.data.referenceNumber);
                            }
                            break;
                        case 'delete':
                            if (operation.type === 'exposure') {
                                await window.deleteExposureFromDb(operation.data.id);
                                console.log('Deleted exposure:', operation.data.id);
                            }
                            break;
                    }
                    successfulSyncs.push(operation);
                } catch (error) {
                    console.error('Sync failed for operation:', operation, error);
                    // Keep failed operations in queue for retry
                }
            }
            
            // Remove successfully synced operations
            offlineData.syncQueue = offlineData.syncQueue.filter(
                op => !successfulSyncs.includes(op)
            );
            offlineData.lastSync = Date.now();
            
            saveOfflineData(offlineData);
            
            syncInProgress = false;
            updateConnectionStatus();
            
            if (successfulSyncs.length > 0) {
                console.log('Successfully synced', successfulSyncs.length, 'operations');
            }
        }
        
        // Override the original saveExposure to handle offline
        const originalSaveExposure = window.saveExposure;
        window.saveExposure = async function(exposure) {
            if (!isOnline) {
                console.log('Offline: Saving exposure locally');
                return window.saveExposureOffline(exposure);
            } else {
                try {
                    return await originalSaveExposure(exposure);
                } catch (error) {
                    console.error('Online save failed, saving offline:', error);
                    return window.saveExposureOffline(exposure);
                }
            }
        };
        
        // Initialize connection status
        document.addEventListener('DOMContentLoaded', () => {
            updateConnectionStatus();
            
            // Try to sync any pending offline data
            if (isOnline) {
                setTimeout(syncOfflineData, 2000);
            }
        });
    </script>
</body>
</html>